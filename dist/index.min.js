var a="ViewdowsMessageBus",c=class{channels;adhocs;constructor(){this.channels=new Map,this.adhocs=new Map,this.createChannel()}createAdHoc(t,e){this.adhocs.set(t,e)}removeAdHoc(t){this.adhocs.delete(t)}sendAdHoc(t,e){this.adhocs.has(t)&&this.adhocs.get(t)?.postMessage(e)}createChannel(){if(!this.channels.has(a)){let t=new BroadcastChannel(a);t.onmessage=e=>{this._dispatch(e.data)},this.channels.set(a,{channel:t,listeners:new Map})}}removeChannel(){this.channels.has(a)&&(this.channels.get(a).channel.close(),this.channels.delete(a))}_dispatch(t){if(this.channels.has(a)){let e=this.channels.get(a).listeners;if(e.has(t.type)){let s=e.get(t.type);if(s)for(let i of s)i.call(this,t)}}}listen(t,e){if(this.channels.has(a)){let s=this.channels.get(a).listeners;s.has(t)||s.set(t,[]),s.get(t).push(e)}}unlisten(t,e){if(this.channels.has(a)){let s=this.channels.get(a).listeners;if(s.has(t)){let i=s.get(t);i.includes(e)&&i.splice(i.indexOf(e),1)}}}broadcast(t,e=!1){for(let{channel:s}of this.channels.values())s.postMessage(t);if(e)for(let s of this.adhocs.values())s.postMessage(t)}},h=c;var p=class{arrangement;layout;messageBus;constructor(t){this.arrangement="isolate",this.layout="left-right",this.messageBus=t}refreshArrange(t){let e={arrangement:"isolate"};if(t.length>1)if(t.sort((s,i)=>s.position.x-i.position.x),t.every((s,i)=>i==0||s.position.y>=t[i-1].position.y&&s.position.y<=t[i-1].position.y+t[i-1].position.height||t[i-1].position.y>=s.position.y&&t[i-1].position.y<=s.position.y+s.position.height))e={arrangement:"tile",layout:"left-right",views:t.map(s=>s.id),position:t.map(s=>[s.position.x,s.position.y,s.position.width,s.position.height])};else if(t.sort((s,i)=>s.position.y-i.position.y),t.every((s,i)=>i==0||s.position.x>=t[i-1].position.x&&s.position.x<=t[i-1].position.x+t[i-1].position.width||t[i-1].position.x>=s.position.x&&t[i-1].position.x<=s.position.x+s.position.width))e={arrangement:"tile",layout:"top-down",views:t.map(s=>s.id),position:t.map(s=>[s.position.x,s.position.y,s.position.width,s.position.height])};else{let s=t[0];for(let i of t)i.position.width>=s.position.width&&i.position.height>=s.position.height&&(s=i);t.every(i=>i.position.x>=s.position.x&&i.position.y>=s.position.y&&i.position.x+i.position.width<=s.position.x+s.position.width&&i.position.y+i.position.height<=s.position.y+s.position.height)&&(e={arrangement:"nest",parentView:s.id,parentPosition:[s.position.x,s.position.y,s.position.width,s.position.height],childrenViews:t.filter(i=>i.id!==s.id).map(i=>i.id),childrenPosition:t.filter(i=>i.id!==s.id).map(i=>[i.position.x,i.position.y,i.position.width,i.position.height])})}(this.arrangement!==e.arrangement||e.arrangement=="tile"&&this.layout!==e.layout)&&(this.arrangement=e.arrangement,e.arrangement=="tile"&&(this.layout=e.layout),this.broadcastArrange(e))}broadcastArrange(t){this.messageBus.broadcast({type:"arrange-update",...t})}},I=p;var l=class{history;locks;messageBus;listeners;constructor(t){this.history=[],this.locks=new Map,this.listeners=new Map,this.messageBus=t,this.setupListeners()}setupListeners(){this.messageBus.listen("event-update",this.addInteraction.bind(this)),this.messageBus.listen("data-update",this.addInteraction.bind(this)),this.messageBus.listen("constraint-update",this.addInteraction.bind(this)),this.messageBus.listen("acquire-lock",this.acquireLock.bind(this)),this.messageBus.listen("release-lock",this.releaseLock.bind(this))}listen(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}addInteraction(t){this.listeners.has(t.type.split("-")[0])&&this.listeners.get(t.type.split("-")[0]).forEach(e=>e(t)),this.history.push(t),this.operationalTransformation()}operationalTransformation(){this.history.sort((t,e)=>t.timestamp-e.timestamp)}getHistory(){return this.history}getLock(t){return this.locks.get(t)}acquireLock(t){this.locks.has(t.lockName)||this.locks.set(t.lockName,[]);let e=this.locks.get(t.lockName);e.push(t.uid),e.length===1&&this.messageBus.broadcast({type:"lock-assignment",uid:e[0],lockName:t.lockName})}releaseLock(t){if(this.locks.get(t.lockName)){let e=this.locks.get(t.lockName);e.length>1&&e.indexOf(t.uid)===0&&this.messageBus.broadcast({type:"lock-assignment",uid:e[1],lockName:t.lockName}),e.includes(t.uid)&&e.splice(e.indexOf(t.uid),1)}}sendHistory(t){this.messageBus.sendAdHoc(t,{type:"sync-history",history:this.getHistory()})}},v=l;var g=class{views;historyManager;displaySpaceManager;messageBus;constructor(t,e,s){this.views=new Map,this.historyManager=t,this.displaySpaceManager=e,this.messageBus=s,this.setupListener()}setupListener(){this.messageBus.listen("register",this.registerView.bind(this)),this.messageBus.listen("unregister",this.unregisterView.bind(this)),this.messageBus.listen("view-update",this.updateViewPosition.bind(this))}registerView(t){this.views.has(t.uid)||(this.views.set(t.uid,{id:t.uid,position:{x:t.x,y:t.y,width:t.width,height:t.height}}),this.analyseViewUpdate(),this.syncHistoryForView(t.uid))}unregisterView(t){this.views.has(t.uid)&&(this.views.delete(t.uid),this.analyseViewUpdate())}updateViewPosition(t){if(this.views.has(t.uid)){let e=this.views.get(t.uid).position;t.x!==void 0&&(e.x=t.x),t.y!==void 0&&(e.y=t.y),t.width!==void 0&&(e.width=t.width),t.height!==void 0&&(e.height=t.height),this.analyseViewUpdate()}}getViews(){return Array.from(this.views.values())}analyseViewUpdate(){let t=this.getViews();this.displaySpaceManager.refreshArrange(t)}syncHistoryForView(t){this.historyManager.sendHistory(t)}},M=g;var m=class{displaySpaceManager;historyManager;viewManager;messageBus;constructor(){this.messageBus=new h,this.displaySpaceManager=new I(this.messageBus),this.historyManager=new v(this.messageBus),this.viewManager=new M(this.historyManager,this.displaySpaceManager,this.messageBus),this.setupCoordinatorLinks()}broadcastData(t){this.messageBus.broadcast({type:"data-update",uid:"coordinator",data:t,timestamp:Date.now()})}broadcastConstraint(t,e="add"){this.messageBus.broadcast({type:"constraint-update",uid:"coordinator",strategy:e,constraint:t,timestamp:Date.now()})}listen(t,e){switch(t){case"event":case"data":case"constraint":return this.historyManager.listen(t,e);case"history":return e(this.historyManager.getHistory())}}setupCoordinatorLinks(){let t=window.onmessage,e=this;window.onmessage=function(s){if(s.source&&s.data&&["register","unregister"].includes(s.data.type)){let i=s.data;switch(i.type){case"register":e.messageBus.createAdHoc(i.uid,s.source),e.viewManager.registerView(i);break;case"unregister":e.messageBus.removeAdHoc(i.uid),e.viewManager.unregisterView(i);break}}typeof t=="function"&&t.call(this,s)}}},L=m;var d,D=new Uint8Array(16);function y(){if(!d&&(d=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!d))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return d(D)}var o=[];for(let n=0;n<256;++n)o.push((n+256).toString(16).slice(1));function V(n,t=0){return o[n[t+0]]+o[n[t+1]]+o[n[t+2]]+o[n[t+3]]+"-"+o[n[t+4]]+o[n[t+5]]+"-"+o[n[t+6]]+o[n[t+7]]+"-"+o[n[t+8]]+o[n[t+9]]+"-"+o[n[t+10]]+o[n[t+11]]+o[n[t+12]]+o[n[t+13]]+o[n[t+14]]+o[n[t+15]]}var E=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),f={randomUUID:E};function C(n,t,e){if(f.randomUUID&&!t&&!n)return f.randomUUID();n=n||{};let s=n.random||(n.rng||y)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,t){e=e||0;for(let i=0;i<16;++i)t[e+i]=s[i];return t}return V(s)}var w=C;var x=class{viewId;messageBus;constructor(t,e){this.messageBus=e,this.setupEventListeners()}setupEventListeners(){document.addEventListener("click",this.sendInteraction.bind(this)),document.addEventListener("dblclick",this.sendInteraction.bind(this)),document.addEventListener("mousemove",this.sendInteraction.bind(this)),document.addEventListener("mousedown",this.sendInteraction.bind(this)),document.addEventListener("mouseup",this.sendInteraction.bind(this)),document.addEventListener("mousewheel",this.sendInteraction.bind(this)),document.addEventListener("wheel",this.sendInteraction.bind(this))}sendInteraction(t){let e="",s=t.target;for(;s;){let i=s.tagName;s.id&&(i+=`#${s.id}`),s.classList.length&&(i+=[...s.classList].map(r=>`.${r}`).join("")),e=`${i} ${e}`,s=s.parentElement}this.messageBus.broadcast({type:"event-update",uid:this.viewId,event:t,targetSelector:e,timestamp:Date.now()})}notifyDataChange(t){this.messageBus.broadcast({type:"data-update",uid:this.viewId,data:t,timestamp:Date.now()})}notifyConstraintChange(t,e){this.messageBus.broadcast({type:"constraint-update",uid:this.viewId,strategy:t,constraint:e,timestamp:Date.now()})}listenEventUpdate(t){this.messageBus.listen("event-update",t)}listenDataUpdate(t){this.messageBus.listen("data-update",t)}listenConstraintUpdate(t){this.messageBus.listen("constraint-update",t)}},U=x;var B=class{viewId;messageBus;position;constructor(t,e){this.viewId=t,this.messageBus=e,this.position={x:0,y:0,width:0,height:0},this.setupObserver()}setupObserver(t=!0){let e=window.screenX,s=window.screenY,i=window.outerWidth,r=window.outerHeight;!t&&(e!==this.position.x||s!==this.position.y||i!==this.position.width||r!==this.position.height)&&this.messageBus.broadcast({type:"view-update",uid:this.viewId,x:e,y:s,width:i,height:r}),requestAnimationFrame(this.setupObserver.bind(this,!1))}listenArrangeChange(t){this.messageBus.listen("arrange-update",t)}},H=B;var b=class{viewId;interactionObserver;viewTracker;messageBus;history;historyListeners=[];constructor(){this.viewId=w(),this.messageBus=new h,this.interactionObserver=new U(this.viewId,this.messageBus),this.viewTracker=new H(this.viewId,this.messageBus),this.messageBus.createAdHoc("coordinator",window.opener),this.messageBus.sendAdHoc("coordinator",{type:"register",uid:this.viewId,...this.viewTracker.position}),window.onbeforeunload=this.destroy.bind(this),this.setupHistoryReceiver()}addHistoryListener(t){this.historyListeners.push(t),this.history&&t(this.history)}setupHistoryReceiver(){let t=window.onmessage,e=this;window.onmessage=function(s){if(s.source&&s.data&&["sync-history"].includes(s.data.type)){let i=s.data;switch(i.type){case"sync-history":e.history=i.history;break}for(let r of e.historyListeners)r(e.history)}typeof t=="function"&&t.call(this,s)}}listen(t,e){switch(t){case"event":return this.interactionObserver.listenEventUpdate(e);case"data":return this.interactionObserver.listenDataUpdate(e);case"constraint":return this.interactionObserver.listenConstraintUpdate(e);case"arrange":return this.viewTracker.listenArrangeChange(e);case"history":return this.addHistoryListener(e)}}destroy(){this.messageBus.sendAdHoc("coordinator",{type:"unregister",uid:this.viewId})}acquireLock(t,e){return new Promise((s,i)=>{let r=!1,u=k=>{r||k.uid===this.viewId&&k.lockName===t&&(r=!0,this.messageBus.unlisten("lock-assignment",u),s(t))};this.messageBus.listen("lock-assignment",u),this.messageBus.broadcast({type:"acquire-lock",uid:this.viewId,lockName:t}),e&&e>0&&setTimeout(()=>{r||(r=!0,this.messageBus.unlisten("lock-assignment",u),this.messageBus.broadcast({type:"release-lock",uid:this.viewId,lockName:t}),i(`Time Exceeded for acquiring \`${t}\` after ${e}ms`))},e)})}releaseLock(t){this.messageBus.broadcast({type:"release-lock",uid:this.viewId,lockName:t})}broadcastData(t){this.messageBus.broadcast({type:"data-update",uid:this.viewId,data:t,timestamp:Date.now()})}broadcastConstraint(t,e="add"){this.messageBus.broadcast({type:"constraint-update",uid:this.viewId,strategy:e,constraint:t,timestamp:Date.now()})}},A=b;var rt={ViewCoordinator:L,ViewWorker:A};export{L as ViewCoordinator,A as ViewWorker,rt as default};
