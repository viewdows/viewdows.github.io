var o="BCastViewMessageBus",c=class{channels;adhocs;constructor(){this.channels=new Map,this.adhocs=new Map,this.createChannel()}createAdHoc(t,s){this.adhocs.set(t,s)}removeAdHoc(t){this.adhocs.delete(t)}sendAdHoc(t,s){this.adhocs.has(t)&&this.adhocs.get(t)?.postMessage(s)}createChannel(){if(!this.channels.has(o)){let t=new BroadcastChannel(o);t.onmessage=s=>{this._dispatch(s.data)},this.channels.set(o,{channel:t,listeners:new Map})}}removeChannel(){this.channels.has(o)&&(this.channels.get(o).channel.close(),this.channels.delete(o))}_dispatch(t){if(this.channels.has(o)){let s=this.channels.get(o).listeners;if(s.has(t.type)){let e=s.get(t.type);if(e)for(let i of e)i.call(this,t)}}}listen(t,s){if(this.channels.has(o)){let e=this.channels.get(o).listeners;e.has(t)||e.set(t,[]),e.get(t).push(s)}}unlisten(t,s){if(this.channels.has(o)){let e=this.channels.get(o).listeners;if(e.has(t)){let i=e.get(t);i.includes(s)&&i.splice(i.indexOf(s),1)}}}broadcast(t,s=!1){for(let{channel:e}of this.channels.values())e.postMessage(t);if(s)for(let e of this.adhocs.values())e.postMessage(t)}},h=c;var l=class{arrangement;layout;messageBus;constructor(t){this.arrangement="isolate",this.layout="left-right",this.messageBus=t}refreshArrange(t){let s={arrangement:"isolate"};if(t.length>1)if(t.sort((e,i)=>e.position.x-i.position.x),t.every((e,i)=>i==0||e.position.y>=t[i-1].position.y&&e.position.y<=t[i-1].position.y+t[i-1].position.height||t[i-1].position.y>=e.position.y&&t[i-1].position.y<=e.position.y+e.position.height))s={arrangement:"tile",layout:"left-right",views:t.map(e=>e.id)};else if(t.sort((e,i)=>e.position.y-i.position.y),t.every((e,i)=>i==0||e.position.x>=t[i-1].position.x&&e.position.x<=t[i-1].position.x+t[i-1].position.width||t[i-1].position.x>=e.position.x&&t[i-1].position.x<=e.position.x+e.position.width))s={arrangement:"tile",layout:"top-down",views:t.map(e=>e.id)};else{let e=t[0];for(let i of t)i.position.width>=e.position.width&&i.position.height>=e.position.height&&(e=i);t.every(i=>i.position.x>=e.position.x&&i.position.y>=e.position.y&&i.position.x+i.position.width<=e.position.x+e.position.width&&i.position.y+i.position.height<=e.position.y+e.position.height)&&(s={arrangement:"nest",parentView:e.id,childrenViews:t.filter(i=>i.id!==e.id).map(i=>i.id)})}(this.arrangement!==s.arrangement||s.arrangement=="tile"&&this.layout!==s.layout)&&(this.arrangement=s.arrangement,s.arrangement=="tile"&&(this.layout=s.layout),this.broadcastArrange(s))}broadcastArrange(t){this.messageBus.broadcast({type:"arrange-update",...t})}},k=l;var p=class{history;locks;messageBus;listeners;constructor(t){this.history=[],this.locks=new Map,this.listeners=new Map,this.messageBus=t,this.setupListeners()}setupListeners(){this.messageBus.listen("event-update",this.addInteraction.bind(this)),this.messageBus.listen("data-update",this.addInteraction.bind(this)),this.messageBus.listen("constraint-update",this.addInteraction.bind(this)),this.messageBus.listen("acquire-lock",this.acquireLock.bind(this)),this.messageBus.listen("release-lock",this.releaseLock.bind(this))}listen(t,s){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(s)}addInteraction(t){this.listeners.has(t.type.split("-")[0])&&this.listeners.get(t.type.split("-")[0]).forEach(s=>s(t)),this.history.push(t),this.operationalTransformation()}operationalTransformation(){this.history.sort((t,s)=>t.timestamp-s.timestamp)}getHistory(){return this.history}getLock(t){return this.locks.get(t)}acquireLock(t){this.locks.has(t.lockName)||this.locks.set(t.lockName,[]);let s=this.locks.get(t.lockName);s.push(t.uid),s.length===1&&this.messageBus.broadcast({type:"lock-assignment",uid:s[0],lockName:t.lockName})}releaseLock(t){if(this.locks.get(t.lockName)){let s=this.locks.get(t.lockName);s.length>1&&s.indexOf(t.uid)===0&&this.messageBus.broadcast({type:"lock-assignment",uid:s[1],lockName:t.lockName}),s.includes(t.uid)&&s.splice(s.indexOf(t.uid),1)}}sendHistory(t){this.messageBus.sendAdHoc(t,{type:"sync-history",history:this.getHistory()})}},I=p;var g=class{views;historyManager;displaySpaceManager;messageBus;constructor(t,s,e){this.views=new Map,this.historyManager=t,this.displaySpaceManager=s,this.messageBus=e,this.setupListener()}setupListener(){this.messageBus.listen("register",this.registerView.bind(this)),this.messageBus.listen("unregister",this.unregisterView.bind(this)),this.messageBus.listen("view-update",this.updateViewPosition.bind(this))}registerView(t){this.views.has(t.uid)||(this.views.set(t.uid,{id:t.uid,position:{x:t.x,y:t.y,width:t.width,height:t.height}}),this.analyseViewUpdate(),this.syncHistoryForView(t.uid))}unregisterView(t){this.views.has(t.uid)&&(this.views.delete(t.uid),this.analyseViewUpdate())}updateViewPosition(t){if(this.views.has(t.uid)){let s=this.views.get(t.uid).position;t.x!==void 0&&(s.x=t.x),t.y!==void 0&&(s.y=t.y),t.width!==void 0&&(s.width=t.width),t.height!==void 0&&(s.height=t.height),this.analyseViewUpdate()}}getViews(){return Array.from(this.views.values())}analyseViewUpdate(){let t=this.getViews();this.displaySpaceManager.refreshArrange(t)}syncHistoryForView(t){this.historyManager.sendHistory(t)}},M=g;var m=class{displaySpaceManager;historyManager;viewManager;messageBus;constructor(){this.messageBus=new h,this.displaySpaceManager=new k(this.messageBus),this.historyManager=new I(this.messageBus),this.viewManager=new M(this.historyManager,this.displaySpaceManager,this.messageBus),this.setupCoordinatorLinks()}broadcastData(t){this.messageBus.broadcast({type:"data-update",uid:"coordinator",data:t,timestamp:Date.now()})}broadcastConstraint(t,s="add"){this.messageBus.broadcast({type:"constraint-update",uid:"coordinator",strategy:s,constraint:t,timestamp:Date.now()})}listen(t,s){switch(t){case"event":case"data":case"constraint":return this.historyManager.listen(t,s);case"history":return s(this.historyManager.getHistory())}}setupCoordinatorLinks(){let t=window.onmessage,s=this;window.onmessage=function(e){if(e.source&&e.data&&["register","unregister"].includes(e.data.type)){let i=e.data;switch(i.type){case"register":s.messageBus.createAdHoc(i.uid,e.source),s.viewManager.registerView(i);break;case"unregister":s.messageBus.removeAdHoc(i.uid),s.viewManager.unregisterView(i);break}}typeof t=="function"&&t.call(this,e)}}},L=m;var d,D=new Uint8Array(16);function y(){if(!d&&(d=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!d))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return d(D)}var a=[];for(let n=0;n<256;++n)a.push((n+256).toString(16).slice(1));function V(n,t=0){return a[n[t+0]]+a[n[t+1]]+a[n[t+2]]+a[n[t+3]]+"-"+a[n[t+4]]+a[n[t+5]]+"-"+a[n[t+6]]+a[n[t+7]]+"-"+a[n[t+8]]+a[n[t+9]]+"-"+a[n[t+10]]+a[n[t+11]]+a[n[t+12]]+a[n[t+13]]+a[n[t+14]]+a[n[t+15]]}var C=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),f={randomUUID:C};function E(n,t,s){if(f.randomUUID&&!t&&!n)return f.randomUUID();n=n||{};let e=n.random||(n.rng||y)();if(e[6]=e[6]&15|64,e[8]=e[8]&63|128,t){s=s||0;for(let i=0;i<16;++i)t[s+i]=e[i];return t}return V(e)}var w=E;var B=class{viewId;messageBus;constructor(t,s){this.messageBus=s,this.setupEventListeners()}setupEventListeners(){document.addEventListener("click",this.sendInteraction.bind(this)),document.addEventListener("dblclick",this.sendInteraction.bind(this)),document.addEventListener("mousemove",this.sendInteraction.bind(this)),document.addEventListener("mousedown",this.sendInteraction.bind(this)),document.addEventListener("mouseup",this.sendInteraction.bind(this)),document.addEventListener("mousewheel",this.sendInteraction.bind(this)),document.addEventListener("wheel",this.sendInteraction.bind(this))}sendInteraction(t){let s="",e=t.target;for(;e;){let i=e.tagName;e.id&&(i+=`#${e.id}`),e.classList.length&&(i+=[...e.classList].map(r=>`.${r}`).join("")),s=`${i} ${s}`,e=e.parentElement}this.messageBus.broadcast({type:"event-update",uid:this.viewId,event:t,targetSelector:s,timestamp:Date.now()})}notifyDataChange(t){this.messageBus.broadcast({type:"data-update",uid:this.viewId,data:t,timestamp:Date.now()})}notifyConstraintChange(t,s){this.messageBus.broadcast({type:"constraint-update",uid:this.viewId,strategy:t,constraint:s,timestamp:Date.now()})}listenEventUpdate(t){this.messageBus.listen("event-update",t)}listenDataUpdate(t){this.messageBus.listen("data-update",t)}listenConstraintUpdate(t){this.messageBus.listen("constraint-update",t)}},U=B;var x=class{viewId;messageBus;position;constructor(t,s){this.viewId=t,this.messageBus=s,this.position={x:0,y:0,width:0,height:0},this.setupObserver()}setupObserver(t=!0){let s=window.screenX,e=window.screenY,i=window.outerWidth,r=window.outerHeight;!t&&(s!==this.position.x||e!==this.position.y||i!==this.position.width||r!==this.position.height)&&this.messageBus.broadcast({type:"view-update",uid:this.viewId,x:s,y:e,width:i,height:r}),requestAnimationFrame(this.setupObserver.bind(this,!1))}listenArrangeChange(t){this.messageBus.listen("arrange-update",t)}},H=x;var b=class{viewId;interactionObserver;viewTracker;messageBus;history;constructor(){this.viewId=w(),this.messageBus=new h,this.interactionObserver=new U(this.viewId,this.messageBus),this.viewTracker=new H(this.viewId,this.messageBus),this.messageBus.createAdHoc("coordinator",window.opener),this.messageBus.sendAdHoc("coordinator",{type:"register",uid:this.viewId,...this.viewTracker.position}),window.onbeforeunload=this.destroy.bind(this),this.setupHistoryReceiver()}setupHistoryReceiver(){let t=window.onmessage,s=this;window.onmessage=function(e){if(e.source&&e.data&&["sync-history"].includes(e.data.type)){let i=e.data;switch(i.type){case"sync-history":s.history=i.history;break}}typeof t=="function"&&t.call(this,e)}}listen(t,s){switch(t){case"event":return this.interactionObserver.listenEventUpdate(s);case"data":return this.interactionObserver.listenDataUpdate(s);case"constraint":return this.interactionObserver.listenConstraintUpdate(s);case"arrange":return this.viewTracker.listenArrangeChange(s);case"history":return s(this.history)}}destroy(){this.messageBus.sendAdHoc("coordinator",{type:"unregister",uid:this.viewId})}acquireLock(t,s){return new Promise((e,i)=>{let r=!1,u=v=>{r||v.uid===this.viewId&&v.lockName===t&&(r=!0,this.messageBus.unlisten("lock-assignment",u),e(t))};this.messageBus.listen("lock-assignment",u),this.messageBus.broadcast({type:"acquire-lock",uid:this.viewId,lockName:t}),s&&s>0&&setTimeout(()=>{r||(r=!0,this.messageBus.unlisten("lock-assignment",u),this.messageBus.broadcast({type:"release-lock",uid:this.viewId,lockName:t}),i(`Time Exceeded for acquiring \`${t}\` after ${s}ms`))},s)})}releaseLock(t){this.messageBus.broadcast({type:"release-lock",uid:this.viewId,lockName:t})}broadcastData(t){this.messageBus.broadcast({type:"data-update",uid:this.viewId,data:t,timestamp:Date.now()})}broadcastConstraint(t,s="add"){this.messageBus.broadcast({type:"constraint-update",uid:this.viewId,strategy:s,constraint:t,timestamp:Date.now()})}},A=b;var rt={ViewCoordinator:L,ViewWorker:A};export{L as ViewCoordinator,A as ViewWorker,rt as default};
